<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <title>Little Red Coffee - Financial Dashboard</title>
    <style>
        :root {
            --primary: #8B2635;
            --primary-light: #A63446;
            --success: #22863a;
            --warning: #b08800;
            --danger: #cb2431;
            --bg: #f6f8fa;
            --card-bg: #ffffff;
            --text: #24292e;
            --text-muted: #586069;
            --border: #e1e4e8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            color: var(--primary);
            font-size: 24px;
            font-weight: 600;
        }

        .period-label {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border);
        }

        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .tab-button:hover {
            color: var(--text);
        }

        .tab-button.active {
            color: var(--primary);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .tab-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            padding: 2px 8px;
            background: #e8f5e9;
            color: var(--success);
            font-size: 10px;
            font-weight: 600;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .tab-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Card Grid */
        .grid {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Info Tooltip */
        .info-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1.5px solid var(--text-muted);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            cursor: help;
            position: relative;
            flex-shrink: 0;
        }

        .info-icon:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .info-icon .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 400;
            text-transform: none;
            letter-spacing: normal;
            line-height: 1.5;
            width: 240px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: opacity 0.2s, visibility 0.2s;
        }

        .info-icon .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--text);
        }

        .info-icon:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Position tooltips on right side for left-aligned cards */
        .card:nth-child(1) .info-icon .tooltip,
        .card:nth-child(2) .info-icon .tooltip {
            left: 0;
            transform: translateX(0);
        }

        .card:nth-child(1) .info-icon .tooltip::after,
        .card:nth-child(2) .info-icon .tooltip::after {
            left: 12px;
            transform: none;
        }

        .card-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
        }

        .card-change {
            font-size: 13px;
            margin-top: 4px;
        }

        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        .neutral { color: var(--text-muted); }

        /* Section Headers */
        .section-header {
            font-size: 18px;
            font-weight: 600;
            margin: 32px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 12px;
            text-transform: uppercase;
        }

        td.number {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        tr:hover {
            background: var(--bg);
        }

        /* Benchmark Bars */
        .benchmark-row {
            margin-bottom: 16px;
        }

        .benchmark-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .benchmark-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .benchmark-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .benchmark-fill.good { background: var(--success); }
        .benchmark-fill.warning { background: var(--warning); }
        .benchmark-fill.concern { background: var(--danger); }

        .benchmark-range {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Debt Progress */
        .debt-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .debt-item:last-child {
            border-bottom: none;
        }

        .debt-name {
            font-weight: 500;
        }

        .debt-amounts {
            text-align: right;
        }

        .debt-current {
            font-weight: 600;
        }

        .debt-paid {
            font-size: 12px;
            color: var(--success);
        }

        /* Progress Bar */
        .progress-container {
            margin: 16px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .progress-bar {
            height: 20px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Square Live Data Badge */
        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #e8f5e9;
            color: var(--success);
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .live-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Refresh Button */
        .refresh-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .refresh-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Cache Status */
        .cache-status {
            font-size: 11px;
            color: var(--text-muted);
        }

        .cache-status.cached {
            color: var(--warning);
        }

        /* Product Mix Table */
        .product-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .product-row:last-child {
            border-bottom: none;
        }

        .product-rank {
            width: 28px;
            height: 28px;
            background: var(--bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            margin-right: 12px;
        }

        .product-rank.top-3 {
            background: var(--primary);
            color: white;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-weight: 500;
            font-size: 14px;
        }

        .product-qty {
            font-size: 12px;
            color: var(--text-muted);
        }

        .product-revenue {
            text-align: right;
        }

        .product-amount {
            font-weight: 600;
            font-size: 14px;
        }

        .product-pct {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Team member list */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .team-member {
            background: var(--bg);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .team-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            margin: 0 auto 8px;
        }

        .team-name {
            font-weight: 500;
            font-size: 13px;
        }

        .team-role {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Grid 3 columns */
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        /* Year Filter Pills */
        .year-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .year-filter-label {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .year-pills {
            display: flex;
            gap: 6px;
        }

        .year-pill {
            padding: 6px 14px;
            border: 1px solid var(--border);
            border-radius: 16px;
            background: var(--card-bg);
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .year-pill:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .year-pill.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Recipe table row hover */
        .recipe-row {
            cursor: pointer;
            transition: background 0.15s;
        }

        .recipe-row:hover {
            background: var(--bg) !important;
        }

        /* Inline Editing */
        .editable-cell {
            cursor: pointer;
            position: relative;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .editable-cell:hover {
            background: #f0f4ff;
        }

        .editable-cell:hover::after {
            content: 'âœŽ';
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: var(--primary);
            opacity: 0.6;
        }

        .edit-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--primary);
            border-radius: 4px;
            font-size: 13px;
            background: white;
            outline: none;
        }

        .edit-input:focus {
            box-shadow: 0 0 0 2px rgba(139, 38, 53, 0.2);
        }

        .edit-label {
            display: block;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .edit-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .save-btn, .cancel-btn, .add-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .save-btn {
            background: var(--primary);
            color: white;
        }

        .save-btn:hover {
            background: var(--primary-light);
        }

        .cancel-btn {
            background: var(--border);
            color: var(--text-muted);
        }

        .cancel-btn:hover {
            background: #d1d5db;
        }

        .add-btn {
            background: var(--success);
            color: white;
        }

        .add-btn:hover {
            background: #1e7731;
        }

        .delete-btn {
            padding: 4px 8px;
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .delete-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
            background: #fff5f5;
        }

        .editing-row {
            background: #fffbeb !important;
        }

        .editing-row td {
            padding: 8px 4px;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: var(--text);
            color: white;
            border-radius: 6px;
            font-size: 13px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
            line-height: 1;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .link-item {
            padding: 12px;
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .link-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .link-item-recipe {
            font-size: 12px;
            color: var(--text-muted);
        }

        .link-item-name {
            font-weight: 600;
        }

        .link-select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
            max-width: 300px;
        }

        .link-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .link-status.linked {
            background: var(--success);
        }

        .link-status.unlinked {
            background: var(--warning);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Little Red Coffee Ltd.</h1>
            <span class="period-label" id="period-label">Loading...</span>
        </header>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-button active" data-tab="financials">Financial Overview</button>
            <button class="tab-button" data-tab="pos">
                Live POS Data
                <span class="tab-badge" id="square-status-badge">Connecting</span>
            </button>
            <button class="tab-button" data-tab="recipes">Recipe Costing</button>
        </div>

        <!-- Tab 1: Financial Overview -->
        <div class="tab-panel active" id="tab-financials">

        <!-- Year Filter -->
        <div class="year-filter">
            <span class="year-filter-label">Fiscal Year:</span>
            <div class="year-pills" id="year-pills">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-4" id="summary-cards">
            <div class="card">
                <div class="card-title">
                    Total Revenue
                    <span class="info-icon">i<span class="tooltip">All money coming into the business from sales, tips, grants, and other income sources for the fiscal year.</span></span>
                </div>
                <div class="card-value" id="revenue">--</div>
                <div class="card-change" id="revenue-change">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Net Income
                    <span class="info-icon">i<span class="tooltip">Your actual profit after ALL expenses (COGS, rent, wages, etc.). This is what you actually keep.</span></span>
                </div>
                <div class="card-value" id="net-income">--</div>
                <div class="card-change" id="net-income-change">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Cash Position
                    <span class="info-icon">i<span class="tooltip">Money available in your bank accounts right now. Important for paying bills and handling emergencies.</span></span>
                </div>
                <div class="card-value" id="cash">--</div>
                <div class="card-change" id="cash-change">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Total Debt
                    <span class="info-icon">i<span class="tooltip">All money you owe including loans (BDC, CIBC) and shareholder loans. Lower is better!</span></span>
                </div>
                <div class="card-value" id="debt">--</div>
                <div class="card-change" id="debt-change">--</div>
            </div>
        </div>

        <!-- Profitability Metrics -->
        <h2 class="section-header">Profitability Metrics</h2>
        <div class="grid grid-4" id="metrics-cards">
            <div class="card">
                <div class="card-title">
                    Gross Margin
                    <span class="info-icon">i<span class="tooltip">Revenue minus direct costs (COGS). Shows how much you keep from each sale before overhead. Coffee shops typically aim for 55-70%.</span></span>
                </div>
                <div class="card-value" id="gross-margin">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Net Margin
                    <span class="info-icon">i<span class="tooltip">Your profit as a percentage of revenue. Shows how much of every dollar you actually keep. Coffee shops typically range 2-10%.</span></span>
                </div>
                <div class="card-value" id="net-margin">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Labor Cost %
                    <span class="info-icon">i<span class="tooltip">Wages and payroll taxes as a percentage of revenue. Coffee shops typically run 25-35%. Lower means more efficient, but watch service quality.</span></span>
                </div>
                <div class="card-value" id="labor-cost">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Rent %
                    <span class="info-icon">i<span class="tooltip">Rent as a percentage of revenue. Coffee shops typically aim for 6-15%. Above 15% can squeeze profitability.</span></span>
                </div>
                <div class="card-value" id="rent-pct">--</div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid grid-2">
            <!-- Industry Benchmarks -->
            <div>
                <h2 class="section-header">Industry Benchmarks</h2>
                <div class="card" id="benchmarks-container">
                    <div class="loading">Loading benchmarks...</div>
                </div>
            </div>

            <!-- Debt Paydown Progress -->
            <div>
                <h2 class="section-header">Debt Paydown Progress</h2>
                <div class="card" id="debt-container">
                    <div class="loading">Loading debt data...</div>
                </div>
            </div>
        </div>

        <!-- Expense Breakdown -->
        <h2 class="section-header">Expense Breakdown</h2>
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        Cost of Goods Sold
                        <span class="info-icon">i<span class="tooltip">Direct costs to make what you sell: coffee beans, food ingredients, cups, and the labor to prepare them.</span></span>
                    </span>
                </div>
                <table id="cogs-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th style="text-align:right">Current</th>
                            <th style="text-align:right">Previous</th>
                            <th style="text-align:right">Change</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        General & Administrative
                        <span class="info-icon">i<span class="tooltip">Overhead costs: rent, insurance, accounting, advertising. These stay relatively fixed regardless of sales volume.</span></span>
                    </span>
                </div>
                <table id="ga-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th style="text-align:right">Current</th>
                            <th style="text-align:right">Previous</th>
                            <th style="text-align:right">Change</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Cash Flow Health -->
        <h2 class="section-header">Cash Flow Health</h2>
        <div class="grid grid-4">
            <div class="card">
                <div class="card-title">
                    Monthly Avg Revenue
                    <span class="info-icon">i<span class="tooltip">Your annual revenue divided by 12. Helps you understand typical monthly income patterns.</span></span>
                </div>
                <div class="card-value" id="monthly-revenue">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Monthly Avg Expenses
                    <span class="info-icon">i<span class="tooltip">Your annual expenses divided by 12. Use this to plan your monthly cash needs.</span></span>
                </div>
                <div class="card-value" id="monthly-expenses">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Monthly Net Income
                    <span class="info-icon">i<span class="tooltip">Average monthly profit. This is roughly what you can expect to have left each month after all expenses.</span></span>
                </div>
                <div class="card-value" id="monthly-net">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Current Ratio
                    <span class="info-icon">i<span class="tooltip">Current assets / current liabilities. Measures ability to pay short-term debts. Above 1.0 is good, above 2.0 is very healthy.</span></span>
                </div>
                <div class="card-value" id="current-ratio">--</div>
            </div>
        </div>

        </div><!-- End Tab 1: Financial Overview -->

        <!-- Tab 2: Live POS Data -->
        <div class="tab-panel" id="tab-pos">

        <!-- Live Sales Header -->
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
            <h2 class="section-header" style="margin: 0; flex: 1; border: none; padding: 0;">Live POS Data (Last 30 Days)</h2>
            <span class="cache-status" id="cache-status"></span>
            <button class="refresh-btn" id="refresh-btn" onclick="refreshSquareData()" title="Refresh data from Square">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
            </button>
            <span class="live-badge" id="square-status">Connecting...</span>
        </div>

        <!-- Live Sales Metrics -->
        <div class="grid grid-4" id="square-metrics">
            <div class="card">
                <div class="card-title">
                    POS Revenue
                    <span class="info-icon">i<span class="tooltip">Total sales recorded in Square POS for the last 30 days. This is real-time data from your register.</span></span>
                </div>
                <div class="card-value" id="square-revenue">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Orders
                    <span class="info-icon">i<span class="tooltip">Number of completed transactions in the last 30 days. More orders = more customers served.</span></span>
                </div>
                <div class="card-value" id="square-orders">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Items Sold
                    <span class="info-icon">i<span class="tooltip">Total number of individual items sold. Higher than order count means customers are buying multiple items.</span></span>
                </div>
                <div class="card-value" id="square-items">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Avg Ticket
                    <span class="info-icon">i<span class="tooltip">Average $ per transaction. Increasing this through upselling is one of the easiest ways to boost revenue.</span></span>
                </div>
                <div class="card-value" id="square-ticket">--</div>
            </div>
        </div>

        <!-- Product Mix & Team -->
        <div class="grid grid-2">
            <!-- Top Sellers -->
            <div>
                <h2 class="section-header">Top Sellers</h2>
                <div class="card" id="product-mix-container">
                    <div class="loading">Loading product data...</div>
                </div>
            </div>

            <!-- Team -->
            <div>
                <h2 class="section-header">Team</h2>
                <div class="card" id="team-container">
                    <div class="loading">Loading team data...</div>
                </div>
            </div>
        </div>

        <!-- Sales by Category -->
        <h2 class="section-header">Sales by Category</h2>
        <div class="card" id="category-container">
            <div class="loading">Loading category data...</div>
        </div>

        </div><!-- End Tab 2: Live POS Data -->

        <!-- Tab 3: Recipe Costing -->
        <div class="tab-panel" id="tab-recipes">

        <!-- Unlinked Ingredients Alert -->
        <div id="unlinked-alert" class="card" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Ingredient Linking Needed</strong>
                    <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">
                        <span id="unlinked-count">0</span> recipe ingredients need to be linked to master ingredients for accurate cost tracking.
                    </div>
                </div>
                <button class="save-btn" onclick="showLinkingModal()" style="padding: 8px 16px;">
                    Review &amp; Link
                </button>
            </div>
        </div>

        <!-- Recipe Summary Cards -->
        <div class="grid grid-4" id="recipe-summary-cards">
            <div class="card">
                <div class="card-title">
                    Total Recipes
                    <span class="info-icon">i<span class="tooltip">Number of recipes loaded from your costing spreadsheet.</span></span>
                </div>
                <div class="card-value" id="recipe-count">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Profitable Items
                    <span class="info-icon">i<span class="tooltip">Recipes where the sale price exceeds the cost (positive profit margin).</span></span>
                </div>
                <div class="card-value positive" id="recipe-profitable">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Needs Attention
                    <span class="info-icon">i<span class="tooltip">Recipes where the cost exceeds the sale price - these may need price adjustments or ingredient changes.</span></span>
                </div>
                <div class="card-value negative" id="recipe-unprofitable">--</div>
            </div>
            <div class="card">
                <div class="card-title">
                    Avg Recipe Cost
                    <span class="info-icon">i<span class="tooltip">Average ingredient cost across all recipes.</span></span>
                </div>
                <div class="card-value" id="recipe-avg-cost">--</div>
            </div>
        </div>

        <!-- Recipe List -->
        <div class="grid grid-2">
            <!-- All Recipes Table -->
            <div>
                <h2 class="section-header">Recipe Profitability</h2>
                <div class="card" style="max-height: 500px; overflow-y: auto;">
                    <table id="recipes-table">
                        <thead>
                            <tr>
                                <th>Recipe</th>
                                <th style="text-align:right">Batch Cost</th>
                                <th style="text-align:right">Revenue</th>
                                <th style="text-align:right">Margin</th>
                            </tr>
                        </thead>
                        <tbody id="recipes-tbody">
                            <tr><td colspan="4" class="loading">Loading recipes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recipe Detail -->
            <div>
                <h2 class="section-header">Recipe Detail</h2>
                <div class="card" id="recipe-detail-container">
                    <div class="loading">Select a recipe to view details</div>
                </div>
            </div>
        </div>

        <!-- Master Ingredients -->
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <h2 class="section-header" style="flex: 1;">Master Ingredients (Costing Sheet)</h2>
            <button class="add-btn" onclick="showAddIngredientForm()">+ Add Ingredient</button>
        </div>

        <!-- Add Ingredient Form (hidden by default) -->
        <div class="card add-ingredient-form" id="add-ingredient-form" style="display: none; margin-bottom: 16px;">
            <div class="card-title" style="margin-bottom: 12px;">Add New Ingredient</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                <div>
                    <label class="edit-label">Name *</label>
                    <input type="text" id="new-ing-name" class="edit-input" placeholder="Ingredient name">
                </div>
                <div>
                    <label class="edit-label">Category</label>
                    <input type="text" id="new-ing-category" class="edit-input" placeholder="Category" list="category-list">
                    <datalist id="category-list"></datalist>
                </div>
                <div>
                    <label class="edit-label">Package Cost ($)</label>
                    <input type="number" id="new-ing-cost" class="edit-input" step="0.01" placeholder="0.00">
                </div>
                <div>
                    <label class="edit-label">Units per Package</label>
                    <input type="number" id="new-ing-units" class="edit-input" step="1" placeholder="0">
                </div>
                <div>
                    <label class="edit-label">Unit Sale Price ($)</label>
                    <input type="number" id="new-ing-sale" class="edit-input" step="0.01" placeholder="0.00">
                </div>
                <div>
                    <label class="edit-label">Supplier</label>
                    <input type="text" id="new-ing-supplier" class="edit-input" placeholder="Supplier name">
                </div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button class="save-btn" onclick="saveNewIngredient()">Save Ingredient</button>
                <button class="cancel-btn" onclick="hideAddIngredientForm()">Cancel</button>
            </div>
        </div>

        <div class="card" style="max-height: 500px; overflow-y: auto;">
            <table id="ingredients-table">
                <thead>
                    <tr>
                        <th>Ingredient</th>
                        <th>Category</th>
                        <th style="text-align:right">Package Cost</th>
                        <th style="text-align:right">Units</th>
                        <th style="text-align:right">Cost/Unit</th>
                        <th>Supplier</th>
                        <th style="width: 80px;"></th>
                    </tr>
                </thead>
                <tbody id="ingredients-tbody">
                    <tr><td colspan="7" class="loading">Loading ingredients...</td></tr>
                </tbody>
            </table>
        </div>

        </div><!-- End Tab 3: Recipe Costing -->

    </div>

    <script>
        // =====================================================================
        // STATE
        // =====================================================================
        let selectedYear = null;  // null = most recent (default)

        // =====================================================================
        // TAB NAVIGATION
        // =====================================================================
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Update active button
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');

                // Show corresponding panel
                const tabId = button.dataset.tab;
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                document.getElementById('tab-' + tabId).classList.add('active');
            });
        });

        // =====================================================================
        // YEAR FILTER
        // =====================================================================
        async function loadFiscalYears() {
            const res = await fetch('/api/fiscal-years');
            const data = await res.json();

            const container = document.getElementById('year-pills');
            container.innerHTML = data.fiscal_years.map((fy, i) => `
                <button class="year-pill ${i === 0 ? 'active' : ''}" data-year="${fy.label}">
                    ${fy.label}
                </button>
            `).join('');

            // Add click handlers
            container.querySelectorAll('.year-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    container.querySelectorAll('.year-pill').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                    selectedYear = pill.dataset.year;
                    loadFinancialData();
                });
            });
        }

        function getYearParam() {
            return selectedYear ? `?year=${selectedYear}` : '';
        }

        async function loadFinancialData() {
            // Load all financial data for selected year
            await Promise.all([
                loadSummary(),
                loadMetrics(),
                loadBenchmarks(),
                loadDebtProgress(),
                loadExpenseBreakdown(),
                loadCashFlow()
            ]);
        }

        // Utility functions
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('en-CA', {
                style: 'currency',
                currency: 'CAD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        };

        const formatPct = (value) => `${value.toFixed(1)}%`;

        const formatChange = (value, isPct = false) => {
            const prefix = value > 0 ? '+' : '';
            if (isPct) {
                return `${prefix}${value.toFixed(1)}%`;
            }
            return `${prefix}${formatCurrency(value)}`;
        };

        const getChangeClass = (value, invertColors = false) => {
            if (value > 0) return invertColors ? 'negative' : 'positive';
            if (value < 0) return invertColors ? 'positive' : 'negative';
            return 'neutral';
        };

        // Load Summary Data
        async function loadSummary() {
            const res = await fetch('/api/summary' + getYearParam());
            const data = await res.json();

            document.getElementById('period-label').textContent = data.current_period;
            document.getElementById('revenue').textContent = formatCurrency(data.current.total_revenue);
            document.getElementById('net-income').textContent = formatCurrency(data.current.net_income);
            document.getElementById('cash').textContent = formatCurrency(data.current.cash);
            document.getElementById('debt').textContent = formatCurrency(data.current.total_debt);

            const revenueChange = document.getElementById('revenue-change');
            const netChange = document.getElementById('net-income-change');
            const cashChange = document.getElementById('cash-change');
            const debtChange = document.getElementById('debt-change');

            if (data.has_comparison) {
                revenueChange.textContent = `${formatChange(data.changes.revenue)} (${formatChange(data.changes.revenue_pct, true)})`;
                revenueChange.className = `card-change ${getChangeClass(data.changes.revenue)}`;

                netChange.textContent = formatChange(data.changes.net_income);
                netChange.className = `card-change ${getChangeClass(data.changes.net_income)}`;

                cashChange.textContent = formatChange(data.changes.cash);
                cashChange.className = `card-change ${getChangeClass(data.changes.cash)}`;

                debtChange.textContent = formatChange(data.changes.debt);
                debtChange.className = `card-change ${getChangeClass(data.changes.debt, true)}`;
            } else {
                // No comparison data available
                revenueChange.textContent = '--';
                revenueChange.className = 'card-change neutral';
                netChange.textContent = '--';
                netChange.className = 'card-change neutral';
                cashChange.textContent = '--';
                cashChange.className = 'card-change neutral';
                debtChange.textContent = '--';
                debtChange.className = 'card-change neutral';
            }
        }

        // Load Metrics
        async function loadMetrics() {
            const res = await fetch('/api/metrics' + getYearParam());
            const data = await res.json();
            const current = data.periods[0];

            document.getElementById('gross-margin').textContent = formatPct(current.gross_margin_pct);
            document.getElementById('net-margin').textContent = formatPct(current.net_margin_pct);
            document.getElementById('labor-cost').textContent = formatPct(current.labor_cost_pct);
            document.getElementById('rent-pct').textContent = formatPct(current.rent_pct);
        }

        // Load Benchmarks
        async function loadBenchmarks() {
            const res = await fetch('/api/benchmarks' + getYearParam());
            const data = await res.json();
            const container = document.getElementById('benchmarks-container');

            let html = '';
            data.benchmarks.forEach(b => {
                const maxVal = Math.max(b.industry_high * 1.3, b.your_value * 1.1);
                const fillWidth = (b.your_value / maxVal) * 100;

                html += `
                    <div class="benchmark-row">
                        <div class="benchmark-label">
                            <span>${b.metric}</span>
                            <span><strong>${b.your_value.toFixed(1)}${b.unit}</strong></span>
                        </div>
                        <div class="benchmark-bar">
                            <div class="benchmark-fill ${b.status}" style="width: ${fillWidth}%"></div>
                        </div>
                        <div class="benchmark-range">
                            Industry range: ${b.industry_low}${b.unit} - ${b.industry_high}${b.unit} (avg: ${b.industry_avg}${b.unit})
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Load Debt Progress
        async function loadDebtProgress() {
            const res = await fetch('/api/debt-progress' + getYearParam());
            const data = await res.json();
            const container = document.getElementById('debt-container');

            let html = '';
            data.loans.forEach(loan => {
                const paidDownText = data.has_comparison ? `Paid down ${formatCurrency(loan.paid_down)}` : '';
                html += `
                    <div class="debt-item">
                        <div class="debt-name">${loan.name}</div>
                        <div class="debt-amounts">
                            <div class="debt-current">${formatCurrency(loan.current)}</div>
                            ${paidDownText ? `<div class="debt-paid positive">${paidDownText}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            if (data.has_comparison) {
                const paidPct = (data.total_paid_down / data.total_previous * 100).toFixed(1);
                html += `
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Total Debt Reduction</span>
                            <span class="positive">${formatCurrency(data.total_paid_down)} (${paidPct}%)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${100 - (data.total_current / data.total_previous * 100)}%"></div>
                        </div>
                        <div class="benchmark-range" style="margin-top: 8px;">
                            Remaining: ${formatCurrency(data.total_current)} of ${formatCurrency(data.total_previous)}
                        </div>
                    </div>
                    <div class="debt-item" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--border);">
                        <div class="debt-name">Equity Position</div>
                        <div class="debt-amounts">
                            <div class="debt-current">${formatCurrency(data.equity_current)}</div>
                            <div class="debt-paid positive">Improved ${formatCurrency(data.equity_improvement)}</div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="debt-item" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--border);">
                        <div class="debt-name">Total Debt</div>
                        <div class="debt-amounts">
                            <div class="debt-current">${formatCurrency(data.total_current)}</div>
                        </div>
                    </div>
                    <div class="debt-item">
                        <div class="debt-name">Equity Position</div>
                        <div class="debt-amounts">
                            <div class="debt-current">${formatCurrency(data.equity_current)}</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Load Expense Breakdown
        async function loadExpenseBreakdown() {
            const res = await fetch('/api/expense-breakdown' + getYearParam());
            const data = await res.json();

            const hasComparison = data.has_comparison;
            const prev = hasComparison ? data.previous : null;

            // COGS Table
            const cogsData = [
                ['Purchases (Food/Bev)', data.current.cogs.purchases, prev?.cogs.purchases || 0],
                ['Payroll', data.current.cogs.payroll, prev?.cogs.payroll || 0],
                ['Total COGS', data.current.cogs.total, prev?.cogs.total || 0],
            ];

            const cogsBody = document.querySelector('#cogs-table tbody');
            cogsBody.innerHTML = cogsData.map(([label, current, previous]) => {
                if (hasComparison) {
                    const change = current - previous;
                    const changeClass = getChangeClass(change, true);
                    return `
                        <tr>
                            <td>${label}</td>
                            <td class="number">${formatCurrency(current)}</td>
                            <td class="number">${formatCurrency(previous)}</td>
                            <td class="number ${changeClass}">${formatChange(change)}</td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr>
                            <td>${label}</td>
                            <td class="number">${formatCurrency(current)}</td>
                            <td class="number">--</td>
                            <td class="number">--</td>
                        </tr>
                    `;
                }
            }).join('');

            // G&A Table
            const gaData = [
                ['Rent', data.current.ga.rent, prev?.ga.rent || 0],
                ['Interest & Bank', data.current.ga.interest_bank, prev?.ga.interest_bank || 0],
                ['Insurance', data.current.ga.insurance, prev?.ga.insurance || 0],
                ['Amortization', data.current.ga.amortization, prev?.ga.amortization || 0],
                ['Accounting/Legal', data.current.ga.accounting, prev?.ga.accounting || 0],
                ['Advertising', data.current.ga.advertising, prev?.ga.advertising || 0],
                ['Other', data.current.ga.other, prev?.ga.other || 0],
                ['Total G&A', data.current.ga.total, prev?.ga.total || 0],
            ];

            const gaBody = document.querySelector('#ga-table tbody');
            gaBody.innerHTML = gaData.map(([label, current, previous]) => {
                if (hasComparison) {
                    const change = current - previous;
                    const changeClass = getChangeClass(change, true);
                    return `
                        <tr>
                            <td>${label}</td>
                            <td class="number">${formatCurrency(current)}</td>
                            <td class="number">${formatCurrency(previous)}</td>
                            <td class="number ${changeClass}">${formatChange(change)}</td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr>
                            <td>${label}</td>
                            <td class="number">${formatCurrency(current)}</td>
                            <td class="number">--</td>
                            <td class="number">--</td>
                        </tr>
                    `;
                }
            }).join('');
        }

        // Load Cash Flow Health
        async function loadCashFlow() {
            const res = await fetch('/api/cash-flow-health' + getYearParam());
            const data = await res.json();

            document.getElementById('monthly-revenue').textContent = formatCurrency(data.monthly_averages.revenue);
            document.getElementById('monthly-expenses').textContent = formatCurrency(data.monthly_averages.expenses);
            document.getElementById('monthly-net').textContent = formatCurrency(data.monthly_averages.net_income);
            document.getElementById('current-ratio').textContent = data.liquidity.current_ratio.toFixed(2);
        }

        // =====================================================================
        // SQUARE LIVE DATA
        // =====================================================================

        // Check Square Status
        async function checkSquareStatus() {
            const badge = document.getElementById('square-status');
            const tabBadge = document.getElementById('square-status-badge');

            function updateBadges(text, bg, color) {
                [badge, tabBadge].forEach(b => {
                    if (b) {
                        b.textContent = text;
                        b.style.background = bg;
                        b.style.color = color;
                    }
                });
            }

            try {
                const res = await fetch('/api/square/status');
                const data = await res.json();

                if (data.connected) {
                    updateBadges('Live', '#e8f5e9', 'var(--success)');
                    return true;
                } else {
                    updateBadges('Not Connected', '#fff3cd', 'var(--warning)');
                    return false;
                }
            } catch (e) {
                updateBadges('Error', '#f8d7da', 'var(--danger)');
                return false;
            }
        }

        // Update cache status display
        function updateCacheStatus(cacheInfo) {
            const statusEl = document.getElementById('cache-status');
            if (!cacheInfo) {
                statusEl.textContent = '';
                return;
            }

            if (cacheInfo.cached) {
                const mins = Math.floor(cacheInfo.age_seconds / 60);
                const secs = cacheInfo.age_seconds % 60;
                const timeAgo = mins > 0 ? `${mins}m ${secs}s ago` : `${secs}s ago`;
                statusEl.textContent = `Cached ${timeAgo}`;
                statusEl.className = 'cache-status cached';
            } else {
                statusEl.textContent = 'Just updated';
                statusEl.className = 'cache-status';
            }
        }

        // Load Product Mix
        async function loadProductMix(forceRefresh = false) {
            try {
                const url = `/api/square/product-mix?days=30${forceRefresh ? '&refresh=true' : ''}`;
                const res = await fetch(url);
                const data = await res.json();

                // Update cache status
                if (data._cache) {
                    updateCacheStatus(data._cache);
                }

                // Update metrics
                document.getElementById('square-revenue').textContent = formatCurrency(data.totals.revenue);
                document.getElementById('square-orders').textContent = data.totals.order_count.toLocaleString();
                document.getElementById('square-items').textContent = data.totals.items_sold.toLocaleString();
                document.getElementById('square-ticket').textContent = formatCurrency(data.totals.avg_ticket);

                // Top products
                const container = document.getElementById('product-mix-container');
                let html = '';
                data.top_items.slice(0, 10).forEach((item, i) => {
                    const rankClass = i < 3 ? 'top-3' : '';
                    html += `
                        <div class="product-row">
                            <div class="product-rank ${rankClass}">${i + 1}</div>
                            <div class="product-info">
                                <div class="product-name">${item.name}</div>
                                <div class="product-qty">${item.quantity} sold</div>
                            </div>
                            <div class="product-revenue">
                                <div class="product-amount">${formatCurrency(item.revenue)}</div>
                                <div class="product-pct">${item.pct_of_revenue}%</div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;

                // Categories
                const catContainer = document.getElementById('category-container');
                let catHtml = '<div style="display: flex; flex-wrap: wrap; gap: 16px;">';
                data.by_category.forEach(cat => {
                    const width = Math.max(cat.pct_of_revenue * 2, 10);
                    catHtml += `
                        <div style="flex: 1; min-width: 200px;">
                            <div class="benchmark-label">
                                <span>${cat.name}</span>
                                <span><strong>${formatCurrency(cat.revenue)}</strong></span>
                            </div>
                            <div class="benchmark-bar">
                                <div class="benchmark-fill good" style="width: ${cat.pct_of_revenue}%"></div>
                            </div>
                            <div class="benchmark-range">${cat.quantity} items (${cat.pct_of_revenue}%)</div>
                        </div>
                    `;
                });
                catHtml += '</div>';
                catContainer.innerHTML = catHtml;

            } catch (e) {
                console.error('Failed to load product mix:', e);
                document.getElementById('product-mix-container').innerHTML =
                    '<div class="loading">Failed to load product data</div>';
            }
        }

        // Load Team Data
        async function loadTeamData(forceRefresh = false) {
            try {
                const url = `/api/square/team${forceRefresh ? '?refresh=true' : ''}`;
                const res = await fetch(url);
                const data = await res.json();

                const container = document.getElementById('team-container');
                let html = '<div class="team-grid">';

                data.team_members.forEach(member => {
                    const initials = member.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    html += `
                        <div class="team-member">
                            <div class="team-avatar">${initials}</div>
                            <div class="team-name">${member.name}</div>
                            <div class="team-role">${member.status || 'Active'}</div>
                        </div>
                    `;
                });

                html += '</div>';

                // Add jobs summary
                if (data.jobs.length > 0) {
                    html += '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">';
                    html += '<div class="card-title" style="margin-bottom: 8px;">Roles</div>';
                    html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                    data.jobs.forEach(job => {
                        const rate = job.hourly_rate ? ` ($${job.hourly_rate}/hr)` : '';
                        html += `<span style="background: var(--bg); padding: 4px 10px; border-radius: 4px; font-size: 12px;">${job.title}${rate}</span>`;
                    });
                    html += '</div></div>';
                }

                container.innerHTML = html;

            } catch (e) {
                console.error('Failed to load team data:', e);
                document.getElementById('team-container').innerHTML =
                    '<div class="loading">Failed to load team data</div>';
            }
        }

        // Refresh Square Data
        async function refreshSquareData() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('loading');
            btn.disabled = true;

            try {
                await Promise.all([
                    loadProductMix(true),
                    loadTeamData(true)
                ]);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // =====================================================================
        // RECIPE COSTING
        // =====================================================================

        let recipesData = [];  // Cache for recipe data
        let ingredientsData = [];  // Cache for ingredients data
        let unlinkedData = [];  // Cache for unlinked ingredients

        // Load unlinked ingredients and show alert if any
        async function loadUnlinkedIngredients() {
            try {
                const res = await fetch('/api/recipes/unlinked');
                const data = await res.json();
                unlinkedData = data.unlinked;

                const alertEl = document.getElementById('unlinked-alert');
                const countEl = document.getElementById('unlinked-count');

                if (data.count > 0) {
                    countEl.textContent = data.count;
                    alertEl.style.display = 'block';
                } else {
                    alertEl.style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to load unlinked ingredients:', e);
            }
        }

        function showLinkingModal() {
            const modal = document.getElementById('linking-modal');
            const body = document.getElementById('linking-modal-body');
            modal.classList.add('active');

            if (unlinkedData.length === 0) {
                body.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">All ingredients are linked!</div>';
                return;
            }

            // Group by recipe for better UX
            const byRecipe = {};
            unlinkedData.forEach(item => {
                if (!byRecipe[item.recipe_name]) {
                    byRecipe[item.recipe_name] = [];
                }
                byRecipe[item.recipe_name].push(item);
            });

            let html = `
                <p style="margin-bottom: 16px; color: var(--text-muted);">
                    Select a master ingredient to link each recipe ingredient. This enables automatic cost updates when ingredient prices change.
                </p>
            `;

            for (const [recipeName, items] of Object.entries(byRecipe)) {
                html += `<div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">${recipeName}</div>`;

                items.forEach(item => {
                    const suggestion = item.linked_id ? ingredientsData.find(i => i.id === item.linked_id) : null;
                    const suggestionText = suggestion ? `Suggested: ${suggestion.name}` : '';

                    html += `
                        <div class="link-item">
                            <div class="link-item-header">
                                <span class="link-item-name">
                                    <span class="link-status unlinked"></span>
                                    ${item.ingredient_name}
                                    ${item.unit_cost ? `<span style="color: var(--text-muted); font-size: 12px;">($${item.unit_cost.toFixed(4)}/unit)</span>` : ''}
                                </span>
                                ${item.confidence ? `<span style="font-size: 11px; color: var(--text-muted);">${(item.confidence * 100).toFixed(0)}% match</span>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select class="link-select" id="link-${item.recipe_id}-${item.ingredient_index}" data-recipe="${item.recipe_id}" data-index="${item.ingredient_index}">
                                    <option value="">-- Select master ingredient --</option>
                                    ${ingredientsData.map(ing =>
                                        `<option value="${ing.id}" ${ing.id === item.linked_id ? 'selected' : ''}>
                                            ${ing.name} (${ing.category}) ${ing.cost_per_unit ? '- $' + ing.cost_per_unit.toFixed(4) + '/unit' : ''}
                                        </option>`
                                    ).join('')}
                                </select>
                                <button class="save-btn" onclick="linkIngredient('${item.recipe_id}', ${item.ingredient_index})" style="padding: 6px 12px; white-space: nowrap;">
                                    Link
                                </button>
                            </div>
                            ${suggestionText ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${suggestionText}</div>` : ''}
                        </div>
                    `;
                });

                html += '</div>';
            }

            body.innerHTML = html;
        }

        function closeLinkingModal() {
            document.getElementById('linking-modal').classList.remove('active');
        }

        async function linkIngredient(recipeId, ingredientIndex) {
            const selectEl = document.getElementById(`link-${recipeId}-${ingredientIndex}`);
            const masterId = selectEl.value;

            if (!masterId) {
                alert('Please select a master ingredient');
                return;
            }

            try {
                const res = await fetch(`/api/recipes/${recipeId}/link-ingredient`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ingredient_index: ingredientIndex,
                        master_ingredient_id: masterId
                    })
                });

                if (!res.ok) {
                    throw new Error('Failed to link ingredient');
                }

                // Update the UI to show success
                const linkItem = selectEl.closest('.link-item');
                const statusEl = linkItem.querySelector('.link-status');
                statusEl.classList.remove('unlinked');
                statusEl.classList.add('linked');

                // Refresh data
                await Promise.all([
                    loadRecipes(),
                    loadUnlinkedIngredients()
                ]);

                // Update the modal if still open
                if (document.getElementById('linking-modal').classList.contains('active')) {
                    showLinkingModal();
                }

            } catch (e) {
                console.error('Failed to link ingredient:', e);
                alert('Failed to link ingredient. Please try again.');
            }
        }

        async function loadRecipes() {
            try {
                const res = await fetch('/api/recipes?sort_by=profit');
                const data = await res.json();
                recipesData = data.recipes;

                // Update summary cards
                document.getElementById('recipe-count').textContent = data.summary.total_recipes;
                document.getElementById('recipe-profitable').textContent = data.summary.profitable_count;
                document.getElementById('recipe-unprofitable').textContent = data.summary.unprofitable_count;
                document.getElementById('recipe-avg-cost').textContent = formatCurrency(data.summary.avg_cost);

                // Populate recipes table
                const tbody = document.getElementById('recipes-tbody');
                tbody.innerHTML = data.recipes.map(recipe => {
                    const cost = recipe.cost_per_recipe;  // Total batch cost
                    const price = recipe.proposed_sale_price;  // Per-portion sale price
                    const portions = recipe.portions || 1;

                    // Calculate batch economics: revenue = price Ã— portions
                    let batchRevenue = null;
                    let batchProfit = null;
                    let marginPct = null;
                    let marginClass = 'neutral';

                    if (price && portions) {
                        batchRevenue = price * portions;
                        if (cost) {
                            batchProfit = batchRevenue - cost;
                            marginPct = (batchProfit / batchRevenue) * 100;
                            marginClass = marginPct >= 0 ? 'positive' : 'negative';
                        }
                    }

                    return `
                        <tr class="recipe-row" data-recipe="${encodeURIComponent(recipe.name)}" onclick="showRecipeDetail('${encodeURIComponent(recipe.name)}')">
                            <td><strong>${recipe.name}</strong></td>
                            <td class="number">${cost ? formatCurrency(cost) : '--'}</td>
                            <td class="number">${batchRevenue ? formatCurrency(batchRevenue) : '--'}</td>
                            <td class="number ${marginClass}">${marginPct !== null ? marginPct.toFixed(0) + '%' : '--'}</td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                console.error('Failed to load recipes:', e);
                document.getElementById('recipes-tbody').innerHTML =
                    '<tr><td colspan="4" class="loading">Failed to load recipes</td></tr>';
            }
        }

        let editingIngredientId = null;  // Currently editing ingredient
        let selectedRecipeId = null;  // Currently selected recipe
        let editingRecipe = false;  // Whether we're in recipe edit mode

        async function loadIngredients() {
            try {
                const res = await fetch('/api/ingredients');
                const data = await res.json();
                ingredientsData = data.ingredients;

                // Populate category datalist for add form
                const categories = [...new Set(data.ingredients.map(i => i.category))];
                document.getElementById('category-list').innerHTML =
                    categories.map(c => `<option value="${c}">`).join('');

                renderIngredientsTable();

            } catch (e) {
                console.error('Failed to load ingredients:', e);
                document.getElementById('ingredients-tbody').innerHTML =
                    '<tr><td colspan="7" class="loading">Failed to load ingredients</td></tr>';
            }
        }

        function renderIngredientsTable() {
            const tbody = document.getElementById('ingredients-tbody');
            tbody.innerHTML = ingredientsData.map(ing => {
                if (editingIngredientId === ing.id) {
                    return renderEditingRow(ing);
                }
                return renderIngredientRow(ing);
            }).join('');
        }

        function renderIngredientRow(ing) {
            return `
                <tr data-id="${ing.id}">
                    <td class="editable-cell" onclick="startEditCell('${ing.id}', 'name')">${ing.name}</td>
                    <td class="editable-cell" onclick="startEditCell('${ing.id}', 'category')">${ing.category}</td>
                    <td class="number editable-cell" onclick="startEditCell('${ing.id}', 'cost')">${ing.cost ? formatCurrency(ing.cost) : '--'}</td>
                    <td class="number editable-cell" onclick="startEditCell('${ing.id}', 'units')">${ing.units || '--'}</td>
                    <td class="number">${ing.cost_per_unit ? '$' + ing.cost_per_unit.toFixed(4) : '--'}</td>
                    <td class="editable-cell" onclick="startEditCell('${ing.id}', 'supplier')">${ing.supplier || '--'}</td>
                    <td>
                        <button class="delete-btn" onclick="confirmDeleteIngredient('${ing.id}', '${ing.name.replace(/'/g, "\\'")}')">Delete</button>
                    </td>
                </tr>
            `;
        }

        function renderEditingRow(ing) {
            return `
                <tr data-id="${ing.id}" class="editing-row">
                    <td><input type="text" class="edit-input" id="edit-name" value="${ing.name || ''}" placeholder="Name"></td>
                    <td><input type="text" class="edit-input" id="edit-category" value="${ing.category || ''}" placeholder="Category" list="category-list"></td>
                    <td><input type="number" class="edit-input" id="edit-cost" value="${ing.cost || ''}" step="0.01" placeholder="Cost"></td>
                    <td><input type="number" class="edit-input" id="edit-units" value="${ing.units || ''}" step="1" placeholder="Units"></td>
                    <td class="number">${ing.cost_per_unit ? '$' + ing.cost_per_unit.toFixed(4) : '--'}</td>
                    <td><input type="text" class="edit-input" id="edit-supplier" value="${ing.supplier || ''}" placeholder="Supplier"></td>
                    <td>
                        <div class="edit-actions">
                            <button class="save-btn" onclick="saveIngredientEdit('${ing.id}')">Save</button>
                            <button class="cancel-btn" onclick="cancelEdit()">Cancel</button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function startEditCell(id, field) {
            editingIngredientId = id;
            renderIngredientsTable();
            // Focus the specific field
            setTimeout(() => {
                const input = document.getElementById('edit-' + field);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 50);
        }

        function cancelEdit() {
            editingIngredientId = null;
            renderIngredientsTable();
        }

        async function saveIngredientEdit(id) {
            const updates = {
                name: document.getElementById('edit-name').value,
                category: document.getElementById('edit-category').value,
                cost: document.getElementById('edit-cost').value,
                units: document.getElementById('edit-units').value,
                supplier: document.getElementById('edit-supplier').value,
            };

            try {
                const res = await fetch(`/api/ingredients/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updates)
                });

                if (!res.ok) throw new Error('Failed to save');

                const data = await res.json();

                // Update local data
                const idx = ingredientsData.findIndex(i => i.id === id);
                if (idx >= 0) {
                    ingredientsData[idx] = data.ingredient;
                }

                editingIngredientId = null;
                renderIngredientsTable();
                showToast('Ingredient updated', 'success');

            } catch (e) {
                console.error('Failed to save ingredient:', e);
                showToast('Failed to save changes', 'error');
            }
        }

        async function confirmDeleteIngredient(id, name) {
            if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;

            try {
                const res = await fetch(`/api/ingredients/${id}`, {method: 'DELETE'});
                if (!res.ok) throw new Error('Failed to delete');

                // Remove from local data
                ingredientsData = ingredientsData.filter(i => i.id !== id);
                renderIngredientsTable();
                showToast('Ingredient deleted', 'success');

            } catch (e) {
                console.error('Failed to delete ingredient:', e);
                showToast('Failed to delete ingredient', 'error');
            }
        }

        // Add ingredient form functions
        function showAddIngredientForm() {
            document.getElementById('add-ingredient-form').style.display = 'block';
            document.getElementById('new-ing-name').focus();
        }

        function hideAddIngredientForm() {
            document.getElementById('add-ingredient-form').style.display = 'none';
            // Clear form
            ['name', 'category', 'cost', 'units', 'sale', 'supplier'].forEach(f => {
                document.getElementById('new-ing-' + f).value = '';
            });
        }

        async function saveNewIngredient() {
            const name = document.getElementById('new-ing-name').value.trim();
            if (!name) {
                showToast('Ingredient name is required', 'error');
                return;
            }

            const data = {
                name: name,
                category: document.getElementById('new-ing-category').value.trim() || 'Uncategorized',
                cost: parseFloat(document.getElementById('new-ing-cost').value) || null,
                units: parseFloat(document.getElementById('new-ing-units').value) || null,
                unit_sale: parseFloat(document.getElementById('new-ing-sale').value) || null,
                supplier: document.getElementById('new-ing-supplier').value.trim() || null,
            };

            try {
                const res = await fetch('/api/ingredients', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error('Failed to create');

                const result = await res.json();
                ingredientsData.unshift(result.ingredient);  // Add to beginning
                renderIngredientsTable();
                hideAddIngredientForm();
                showToast('Ingredient added', 'success');

            } catch (e) {
                console.error('Failed to add ingredient:', e);
                showToast('Failed to add ingredient', 'error');
            }
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Handle Enter key in edit inputs
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && editingIngredientId) {
                e.preventDefault();
                saveIngredientEdit(editingIngredientId);
            }
            if (e.key === 'Escape' && editingIngredientId) {
                cancelEdit();
            }
        });

        function showRecipeDetail(encodedName, forceEditMode = false) {
            const name = decodeURIComponent(encodedName);
            const recipe = recipesData.find(r => r.name === name);
            if (!recipe) return;

            selectedRecipeId = recipe.id;
            if (forceEditMode) editingRecipe = true;

            // Highlight selected row
            document.querySelectorAll('.recipe-row').forEach(row => row.style.background = '');
            const selectedRow = document.querySelector(`.recipe-row[data-recipe="${encodedName}"]`);
            if (selectedRow) selectedRow.style.background = 'var(--bg)';

            const container = document.getElementById('recipe-detail-container');

            // Batch economics calculation
            const batchCost = recipe.cost_per_recipe;
            const pricePerPortion = recipe.proposed_sale_price;
            const portions = recipe.portions || 1;

            let batchRevenue = null;
            let batchProfit = null;
            let marginPct = null;

            if (pricePerPortion && portions) {
                batchRevenue = pricePerPortion * portions;
                if (batchCost) {
                    batchProfit = batchRevenue - batchCost;
                    marginPct = (batchProfit / batchRevenue) * 100;
                }
            }

            const marginClass = marginPct !== null && marginPct >= 0 ? 'positive' : 'negative';
            const profitBgColor = marginPct !== null && marginPct >= 0 ? '#e8f5e9' : '#ffebee';

            let html = '';

            if (editingRecipe) {
                // EDIT MODE
                html = `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <label class="edit-label">Recipe Name</label>
                                <input type="text" class="edit-input" id="edit-recipe-name" value="${recipe.name || ''}" style="font-size: 16px; font-weight: 600;">
                            </div>
                        </div>
                        <div style="margin-top: 8px;">
                            <label class="edit-label">Concept/Description</label>
                            <input type="text" class="edit-input" id="edit-recipe-concept" value="${recipe.concept || ''}" placeholder="e.g., Signature drink, Seasonal item">
                        </div>
                    </div>

                    <div class="grid grid-2" style="margin-bottom: 12px; gap: 12px;">
                        <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                            <div class="card-title" style="margin-bottom: 4px;">Batch Cost</div>
                            <div style="font-size: 20px; font-weight: 600;">${batchCost ? formatCurrency(batchCost) : '--'}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">From ingredients (not editable)</div>
                        </div>
                        <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                            <div class="card-title" style="margin-bottom: 4px;">Batch Revenue</div>
                            <div style="font-size: 20px; font-weight: 600;" id="edit-batch-revenue">${batchRevenue ? formatCurrency(batchRevenue) : '--'}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Calculated from price x portions</div>
                        </div>
                    </div>

                    <div style="background: ${profitBgColor}; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Batch Profit</span>
                            <span class="${marginClass}" style="font-size: 18px; font-weight: 600;" id="edit-batch-profit">
                                ${batchProfit !== null ? formatCurrency(batchProfit) : '--'}
                                ${marginPct !== null ? ` (${marginPct.toFixed(1)}%)` : ''}
                            </span>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div class="card-title" style="margin-bottom: 8px;">Editable Fields</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                            <div>
                                <label class="edit-label">Portions per batch</label>
                                <input type="number" class="edit-input" id="edit-recipe-portions" value="${portions}" min="1" step="1" onchange="updateRecipePreview()">
                            </div>
                            <div>
                                <label class="edit-label">Price per portion ($)</label>
                                <input type="number" class="edit-input" id="edit-recipe-price" value="${pricePerPortion || ''}" min="0" step="0.01" onchange="updateRecipePreview()">
                            </div>
                            <div>
                                <label class="edit-label">Prep Time (minutes)</label>
                                <input type="number" class="edit-input" id="edit-recipe-prep" value="${recipe.prep_time_minutes || ''}" min="0" step="1">
                            </div>
                            <div>
                                <label class="edit-label">Labor Cost ($)</label>
                                <input type="number" class="edit-input" id="edit-recipe-labor" value="${recipe.cost_in_wages || ''}" min="0" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button class="save-btn" onclick="saveRecipeEdit()">Save Changes</button>
                        <button class="cancel-btn" onclick="cancelRecipeEdit()">Cancel</button>
                    </div>
                `;
            } else {
                // VIEW MODE
                html = `
                    <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 4px 0; font-size: 20px;">${recipe.name}</h3>
                            ${recipe.concept ? `<div style="color: var(--text-muted); font-size: 13px;">${recipe.concept}</div>` : ''}
                        </div>
                        <button class="save-btn" onclick="startRecipeEdit()" style="padding: 6px 12px; font-size: 12px;">Edit</button>
                    </div>

                    <div class="grid grid-2" style="margin-bottom: 12px; gap: 12px;">
                        <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                            <div class="card-title" style="margin-bottom: 4px;">Batch Cost</div>
                            <div style="font-size: 20px; font-weight: 600;">${batchCost ? formatCurrency(batchCost) : '--'}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Total ingredient cost</div>
                        </div>
                        <div style="background: var(--bg); padding: 12px; border-radius: 6px;">
                            <div class="card-title" style="margin-bottom: 4px;">Batch Revenue</div>
                            <div style="font-size: 20px; font-weight: 600;">${batchRevenue ? formatCurrency(batchRevenue) : '--'}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${pricePerPortion ? formatCurrency(pricePerPortion) : '--'} x ${portions} portions</div>
                        </div>
                    </div>

                    <div style="background: ${profitBgColor}; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Batch Profit</span>
                            <span class="${marginClass}" style="font-size: 18px; font-weight: 600;">
                                ${batchProfit !== null ? formatCurrency(batchProfit) : '--'}
                                ${marginPct !== null ? ` (${marginPct.toFixed(1)}%)` : ''}
                            </span>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div class="card-title" style="margin-bottom: 8px;">Recipe Details</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                            <div>Portions per batch: <strong>${portions}</strong></div>
                            <div>Price per portion: <strong>${pricePerPortion ? formatCurrency(pricePerPortion) : '--'}</strong></div>
                            <div>Cost per portion: <strong>${recipe.cost_per_portion ? formatCurrency(recipe.cost_per_portion) : '--'}</strong></div>
                            <div>Prep Time: <strong>${recipe.prep_time_minutes ? recipe.prep_time_minutes + ' min' : '--'}</strong></div>
                            <div>Labor Cost: <strong>${recipe.cost_in_wages ? formatCurrency(recipe.cost_in_wages) : '--'}</strong></div>
                        </div>
                    </div>
                `;
            }

            if (recipe.ingredients && recipe.ingredients.length > 0) {
                const linkedCount = recipe.ingredients.filter(i => i.ingredient_id && i.match_confidence >= 0.8).length;
                const needsLinking = recipe.ingredients.length - linkedCount;

                html += `
                    <div class="card-title" style="margin-bottom: 8px;">
                        Ingredients (${recipe.ingredients.length})
                        ${needsLinking > 0 ? `<span style="font-size: 11px; color: var(--warning); font-weight: normal; margin-left: 8px;">${needsLinking} need linking</span>` : ''}
                    </div>
                    <table style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th style="text-align:right">Qty</th>
                                <th style="text-align:right">Unit Cost</th>
                                <th style="text-align:right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recipe.ingredients.map(ing => {
                                const isLinked = ing.ingredient_id && ing.match_confidence >= 0.8;
                                const statusClass = isLinked ? 'linked' : 'unlinked';
                                return `
                                <tr>
                                    <td>
                                        <span class="link-status ${statusClass}" title="${isLinked ? 'Linked to master ingredient' : 'Needs linking'}"></span>
                                        ${ing.name}
                                    </td>
                                    <td class="number">${ing.quantity || '--'}</td>
                                    <td class="number">${ing.unit_cost ? '$' + ing.unit_cost.toFixed(4) : '--'}</td>
                                    <td class="number">${ing.total_cost ? formatCurrency(ing.total_cost) : '--'}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                `;
            }

            container.innerHTML = html;
        }

        function startRecipeEdit() {
            editingRecipe = true;
            const recipe = recipesData.find(r => r.id === selectedRecipeId);
            if (recipe) {
                showRecipeDetail(encodeURIComponent(recipe.name), true);
            }
        }

        function cancelRecipeEdit() {
            editingRecipe = false;
            const recipe = recipesData.find(r => r.id === selectedRecipeId);
            if (recipe) {
                showRecipeDetail(encodeURIComponent(recipe.name));
            }
        }

        function updateRecipePreview() {
            // Live preview of batch revenue/profit as user edits
            const recipe = recipesData.find(r => r.id === selectedRecipeId);
            if (!recipe) return;

            const batchCost = recipe.cost_per_recipe;
            const portions = parseInt(document.getElementById('edit-recipe-portions').value) || 1;
            const price = parseFloat(document.getElementById('edit-recipe-price').value) || 0;

            const batchRevenue = price * portions;
            const batchProfit = batchCost ? batchRevenue - batchCost : null;
            const marginPct = batchRevenue > 0 && batchCost ? (batchProfit / batchRevenue) * 100 : null;

            const revenueEl = document.getElementById('edit-batch-revenue');
            const profitEl = document.getElementById('edit-batch-profit');

            if (revenueEl) revenueEl.textContent = formatCurrency(batchRevenue);
            if (profitEl) {
                const marginClass = marginPct !== null && marginPct >= 0 ? 'positive' : 'negative';
                profitEl.className = marginClass;
                profitEl.style.fontSize = '18px';
                profitEl.style.fontWeight = '600';
                profitEl.textContent = batchProfit !== null
                    ? `${formatCurrency(batchProfit)} (${marginPct.toFixed(1)}%)`
                    : '--';
            }
        }

        async function saveRecipeEdit() {
            const recipe = recipesData.find(r => r.id === selectedRecipeId);
            if (!recipe) return;

            const updates = {
                name: document.getElementById('edit-recipe-name').value,
                concept: document.getElementById('edit-recipe-concept').value,
                portions: document.getElementById('edit-recipe-portions').value,
                proposed_sale_price: document.getElementById('edit-recipe-price').value,
                prep_time_minutes: document.getElementById('edit-recipe-prep').value,
                cost_in_wages: document.getElementById('edit-recipe-labor').value,
            };

            try {
                const res = await fetch(`/api/recipes/${recipe.id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updates)
                });

                if (!res.ok) throw new Error('Failed to save');

                const data = await res.json();

                // Update local data
                const idx = recipesData.findIndex(r => r.id === recipe.id);
                if (idx >= 0) {
                    recipesData[idx] = data.recipe;
                }

                editingRecipe = false;
                showRecipeDetail(encodeURIComponent(data.recipe.name));
                loadRecipes();  // Refresh the table to show updated values
                showToast('Recipe updated', 'success');

            } catch (e) {
                console.error('Failed to save recipe:', e);
                showToast('Failed to save changes', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Load fiscal years and render pills
            await loadFiscalYears();

            // Load accounting data (for default/most recent year)
            loadFinancialData();

            // Load Square live data
            const squareConnected = await checkSquareStatus();
            if (squareConnected) {
                loadProductMix();
                loadTeamData();
            } else {
                document.getElementById('product-mix-container').innerHTML =
                    '<div class="loading">Square not connected. Add SQUARE_ACCESS_TOKEN to .env</div>';
                document.getElementById('team-container').innerHTML =
                    '<div class="loading">Square not connected</div>';
                document.getElementById('category-container').innerHTML =
                    '<div class="loading">Square not connected</div>';
            }

            // Load recipe costing data
            loadRecipes();
            loadIngredients();
            loadUnlinkedIngredients();
        });
    </script>

    <!-- Ingredient Linking Modal -->
    <div class="modal-overlay" id="linking-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Link Recipe Ingredients</h3>
                <button class="modal-close" onclick="closeLinkingModal()">&times;</button>
            </div>
            <div class="modal-body" id="linking-modal-body">
                <div class="loading">Loading unlinked ingredients...</div>
            </div>
        </div>
    </div>
</body>
</html>
